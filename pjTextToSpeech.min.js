"use strict";angular.module("pjTts.directives",["pjTts.factories"]).directive("tts",["TTSAudio",function(a){return{restrict:"E",template:'<button ng-click="speak()" class="pj-tts btn btn-primary"><span ng-class="tts.$pending && \'glyphicon-refresh\' || \'glyphicon-volume-down\'" class="glyphicon "></span></button>',scope:{ttsText:"@",ttsLang:"@"},link:function(b){b.tts=!1,b.speak=function(){b.tts||(b.tts=new a),b.tts.speak({text:b.ttsText,lang:b.ttsLang})},b.$on("$destroy",function(){b.tts&&b.tts.clear()})}}}]),angular.module("pjTts.factories",[]).factory("TTSAudio",["$log","$timeout","$interval","$window","AudioLoaderService","$rootScope","TTS_EVENTS",function(a,b,c,d,e,f,g){return function(){var h=this,i=!1,j=!1,k=null;h.$pending=!1,h.$hasError=!1,h.isAudioSupported=function(){if("undefined"==typeof d.Audio)return!1;try{return new d.Audio,!0}catch(a){}return!1};var l=h.isAudioSupported()?new d.Audio:!1;h.speak=function(d){function m(){b(function(){l.play(),j||(j=c(function(){h.$pending=i&&!l.paused,h.$pending||(f.$broadcast(g.SUCCESS),h.clear())},50))},1)}function n(a){l.src=a.data.path,i=!0,m(),h.$hasError=!1}function o(a){h.$hasError=!0,f.$broadcast(g.FAILED)}function p(){return d.text+"#"+d.lang}if(!h.isAudioSupported())return void a.warn("HTML5 audio is not supported.");if(!angular.isDefined(d)||!d.text.length){var q="Nothing to speak";return a.warn(q),void f.$broadcast(g.FAILED,q)}i&&k===p()?m():(h.clear(),f.$broadcast(g.PENDING,d.text),h.$pending=!0,k=p(),e.load(d).then(n,o))},h.clear=function(){j&&(c.cancel(j),j=!1)}}}]).service("AudioLoaderService",["$http","TTSConfig",function(a,b){this.load=function(c){return a({url:b.url,method:"GET",params:c})}}]),angular.module("pjTts",["pjTts.directives","pjTts.factories"]).value("TTSConfig",{url:""}).constant("TTS_EVENTS",{PENDING:"tts-pending",SUCCESS:"tts-success",FAILED:"tts-failed"});