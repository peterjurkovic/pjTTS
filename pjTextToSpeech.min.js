"use strict";angular.module("pjTts.directives",["pjTts.factories"]).directive("tts",["$log","TTSAudio",function(a,b){return{restrict:"E",template:'<div class="pj-tts" ng-click="speak()"><button class="btn btn-primary"><span ng-if="tts.$pending" class="glyphicon glyphicon-refresh"></span><span ng-if="!tts || !tts.$pending" class="glyphicon glyphicon-volume-down"></span></button></div>',scope:{ttsText:"@",ttsLang:"@"},link:function(a){a.tts=!1,a.speak=function(){a.tts||(a.tts=new b),a.tts.speak({text:a.ttsText,lang:a.ttsLang})},a.$on("$destroy",function(){a.tts&&a.tts.clear()})}}}]),angular.module("pjTts.factories",[]).factory("TTSAudio",["$log","$timeout","$interval","$window","AudioLoaderService","$rootScope","TTS_EVENTS",function(a,b,c,d,e,f,g){return function(){var h=this,i=!1,j=!1,k=null;h.$pending=!1,h.$hasError=!1,h.isAudioSupported=function(){if("undefined"==typeof d.Audio)return!1;try{return new d.Audio,!0}catch(a){}return!1};var l=h.isAudioSupported()?new d.Audio:!1;h.speak=function(d){function m(){b(function(){l.play(),j||(j=c(function(){h.$pending=i&&!l.paused,h.$pending||(f.$broadcast(g.SUCCESS),h.clean())},50))},1)}function n(a){l.src=a.data.path,i=!0,m(),h.$hasError=!1}function o(a){h.$hasError=!0,f.$broadcast(g.FAILED)}function p(){return d.text+"#"+d.lang}if(!h.isAudioSupported())return void a.warn("HTML5 audio is not supported.");if(!angular.isDefined(d)||!d.text.length){var q="Nothing to speak";return a.warn(q),void f.$broadcast(g.FAILED,q)}i&&k===p()?m():(h.clean(),f.$broadcast(g.PENDING,d.text),h.$pending=!0,k=p(),e.load(d).then(n,o))},h.clean=function(){j&&(c.cancel(j),j=!1)}}}]).service("AudioLoaderService",["$http","TTSConfig",function(a,b){this.load=function(c){return a({url:b.url,method:"GET",params:c})}}]),angular.module("pjTts",["pjTts.directives","pjTts.factories"]).value("TTSConfig",{url:""}).constant("TTS_EVENTS",{PENDING:"tts-pending",SUCCESS:"tts-success",FAILED:"tts-failed"});