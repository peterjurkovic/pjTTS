"use strict";angular.module("pjTts.directives",["pjTts.factories"]).directive("tts",["$log","TTSAudio",function(a,b){return{restrict:"E",template:'<div class="pj-tts" ng-click="speak()"><button class="btn btn-primary"><span ng-if="tts.$pending" class="glyphicon glyphicon glyphicon-refresh"></span><span ng-if="!tts.$pending" class="glyphicon glyphicon-volume-down"></span></button></div>',scope:{ttsText:"=",ttsLang:"="},link:function(a){a.tts=!1,a.speak=function(){a.tts||(a.tts=new b),a.tts.speak({text:a.ttsTest,lang:a.ttsLang})},a.$on("$destroy",function(){a.tts&&a.tts.clear()})}}}]),angular.module("pjTts.factories",[]).factory("TTSAudio",["$log","$timeout","$interval","$window","AudioLoaderService","$rootScope","TTS_EVENTS",function(a,b,c,d,e,f,g){return function(){function h(){if("undefined"==typeof d.Audio)return!1;try{return new d.Audio,!0}catch(a){}return!1}var i=h(),j=this,k=!1,l=!1,m=null,n=i?new d.Audio:!1;j.$pending=!1,j.$hasError=!1,j.speak=function(d){function h(){b(function(){n.play(),l||(l=c(function(){j.$pending=k&&!n.paused,j.$pending||(f.$broadcast(g.SUCCESS),j.clean())},50))},1)}function o(a){n.src=a.data.path,h(),k=!0,j.$hasError=!1}function p(a){j.$hasError=!0,f.$broadcast(g.FAILED)}function q(){return d.text+"#"+d.lang}return i?angular.isDefined(d)&&d.text?(d.lang=!d.lang||"en",void(k&&m===q()?h():(j.clean(),f.$broadcast(g.PENDING),j.$pending=!0,m=q(),e.load(d).then(o,p)))):void a.warn("Nothing to speak"):void a.warn("HTML5 audio is not supported.")},j.clean=function(){l&&(c.cancel(l),l=!1)}}}]).service("AudioLoaderService",["$http","TTSConfig",function(a,b){this.load=function(c){return a({url:b.url,method:"GET",params:c})}}]),angular.module("pjTts",["pjTts.directives","pjTts.factories"]).value("TTSConfig",{url:"http://drilapp.dev/api/v1/tts"}).constant("TTS_EVENTS",{PENDING:"tts-pending",SUCCESS:"tts-success",FAILED:"tts-failed"});